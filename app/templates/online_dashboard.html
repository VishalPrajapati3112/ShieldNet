<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>{{ title or "ShieldNet | Online Transfer" }}</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
/* ===== BASE ===== */
body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  color: #fff;
  background: radial-gradient(circle at 25% 25%, #001f3f, #000814);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}
body::before, body::after {
  content: '';
  position: absolute;
  width: 600px;
  height: 600px;
  border-radius: 50%;
  background: radial-gradient(circle, rgba(0, 204, 255, 0.25), transparent 70%);
  filter: blur(200px);
  animation: floaty 18s ease-in-out infinite alternate;
}
body::before { top: -200px; left: -150px; }
body::after { bottom: -250px; right: -200px; }
@keyframes floaty {
  from { transform: translateY(0) rotate(0deg); }
  to { transform: translateY(-60px) rotate(15deg); }
}

/* ===== HEADER ===== */
header {
  width: 100%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 100px 15px 40px;
  background: rgba(0, 0, 20, 0.4);
  backdrop-filter: blur(12px);
  position: fixed;
  top: 0;
  left: 0;
  z-index: 10;
}
.nav-left { display: flex; align-items: center; gap: 10px; }
.nav-left img { width: 38px; height: 38px; border-radius: 50%; }
.nav-left h1 { margin: 0; color: #00e0ff; font-weight: 600; font-size: 1.5rem; }

/* ===== PROFILE MENU ===== */
.profile-menu { position: relative; display: inline-block; margin-right: 70px; }
.profile-icon {
  width: 42px; height: 42px; border-radius: 50%;
  background: linear-gradient(135deg, #00e0ff, #007bff);
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 0 12px rgba(0, 224, 255, 0.4);
  cursor: pointer; transition: transform 0.2s ease, box-shadow 0.3s ease;
}
.profile-icon:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(0,224,255,0.8); }
.dropdown-content {
  display: none; position: absolute; right: -25px; top: 55px;
  background: rgba(0, 0, 30, 0.9); backdrop-filter: blur(10px);
  min-width: 180px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,255,255,0.3);
}
.dropdown-content a {
  display: block; padding: 12px 16px; text-decoration: none; color: #fff;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.dropdown-content a:hover { background: rgba(0,255,255,0.15); color: #00eaff; }
.profile-menu.active .dropdown-content { display: block; }

/* ===== INFO BANNER ===== */
.info-banner {
  margin: 100px auto 20px; width: 70%;
  background: linear-gradient(90deg, rgba(0,255,150,0.2), rgba(0,180,255,0.2));
  border: 1px solid rgba(0,255,255,0.3);
  border-radius: 10px; text-align: center;
  padding: 12px 20px; box-shadow: 0 0 15px rgba(0,255,255,0.15);
  display: flex; justify-content: center; align-items: center; gap: 10px;
}
.info-banner strong { color: #00ffff; text-shadow: 0 0 10px rgba(0,255,255,0.8); }
.copy-btn {
  background: linear-gradient(135deg, #00e0ff, #00ffcc);
  color: #001f3f; border: none; border-radius: 6px;
  padding: 6px 12px; cursor: pointer; font-weight: 600;
  transition: 0.3s; box-shadow: 0 0 8px rgba(0,255,255,0.4);
}
.copy-btn:hover { background: linear-gradient(135deg, #00ffff, #00bfff); }

/* ===== CONTAINER ===== */
.container {
  max-width: 1100px; margin: 20px auto 100px;
  display: grid; grid-template-columns: 1fr 340px; gap: 25px;
}

/* ===== CARD ===== */
.card {
  background: linear-gradient(145deg, rgba(10,30,60,0.95), rgba(0,0,0,0.7));
  border: 1px solid rgba(0,153,255,0.25);
  border-radius: 16px; padding: 20px;
  box-shadow: 0 0 12px rgba(0,153,255,0.3);
  backdrop-filter: blur(12px);
}

/* ===== DRAG ZONE ===== */
#drop-zone {
  border: 2px dashed rgba(0,255,255,0.4); border-radius: 12px;
  padding: 30px; text-align: center; background: rgba(0,255,255,0.05);
  color: #aeeeff; cursor: pointer; transition: 0.3s;
}
#drop-zone.dragover { background: rgba(0,255,255,0.15); border-color: #00ffff; }
#file-names { margin-top: 10px; color: #b8e3ff; font-size: 0.9rem; }

/* ===== PARTICIPANTS JOIN ANIMATION ===== */
#participants li {
  list-style: none; padding: 6px 0; color: #bdeeff;
  transition: 0.3s; opacity: 0.85;
}
#participants li.new-join {
  animation: joinGlow 1.2s ease;
}
@keyframes joinGlow {
  0% { opacity: 0; transform: translateX(20px); color: #00ffff; }
  100% { opacity: 1; transform: translateX(0); color: #bdeeff; }
}

/* ===== COUNTDOWN BAR ===== */
#timeout-progress {
  width: 70%; height: 8px; margin: 10px auto;
  background: rgba(255,255,255,0.1);
  border-radius: 5px; overflow: hidden; display: none;
}
#timeout-bar {
  height: 100%; width: 100%;
  background: linear-gradient(90deg, #00ffff, #007bff);
  transition: width 1s linear;
}

/* ===== TOAST ===== */
.toast-container {
  position: fixed; bottom: 25px; right: 25px; z-index: 9999;
}
.toast {
  background: rgba(0,255,255,0.15);
  border-left: 4px solid #00ffff;
  padding: 12px 18px; border-radius: 10px;
  margin-top: 10px; color: #fff; font-weight: 500;
  opacity: 0; transform: translateX(30px);
  animation: fadeIn 0.5s forwards;
}
@keyframes fadeIn { to { opacity: 1; transform: translateX(0); } }
.toast.fade-out { animation: fadeOut 0.6s forwards; }
@keyframes fadeOut { to { opacity: 0; transform: translateX(50px); } }

/* ===== FOOTER ===== */
.footer-text {
  position: fixed; bottom: 10px; width: 100%;
  text-align: center; color: rgba(255,255,255,0.6);
  font-size: 0.9rem;
}
  </style>
</head>
<body>
<header>
  <div class="nav-left">
    <img src="{{ url_for('static', filename='logo.png') }}" alt="ShieldNet Logo">
    <h1>SHIELDNET</h1>
  </div>
  <div class="profile-menu" id="profileMenu">
    <div class="profile-icon">ðŸ‘¤</div>
    <div class="dropdown-content">
      <a href="#">My Profile</a>
      <a href="#">Change Password</a>
      <a href="{{ url_for('auth.logout') }}">Logout</a>
    </div>
  </div>
</header>

<div class="info-banner">
  âœ… Session created successfully. Share this token with receivers:
  <strong id="token-text">{{ token }}</strong>
  <button class="copy-btn" id="copy-btn">Copy</button>
</div>

<!-- Countdown bar -->
<div id="timeout-progress">
  <div id="timeout-bar"></div>
</div>

<div class="container">
  <!-- LEFT SIDE -->
  <div class="card">
    <h3>Session: <span id="session-token">{{ token }}</span></h3>
    <p class="small">Owner: {{ owner_name }}</p>
    <h4>Upload Files</h4>
    <div id="drop-zone">Drag & Drop files here or click to select</div>
    <input type="file" id="file-input" multiple style="display:none;">
    <div id="file-names"></div>
    <button id="upload-btn" class="copy-btn" style="margin-top:15px;">Upload</button>
    <div id="progress-wrap" style="display:none;margin-top:8px;">
      <progress id="upload-progress" value="0" max="100"></progress>
      <div id="progress-text"></div>
    </div>
    <h4 style="margin-top:20px;">Files</h4>
    <ul id="file-list"></ul>
  </div>

  <!-- RIGHT SIDE -->
  <div class="card">
    <h4>Participants (<span id="pcount">{{ participants|length }}</span>)</h4>
    <ul id="participants">
      {% for p in participants %}
        <li>{{ p }}</li>
      {% endfor %}
    </ul>

    {% if is_owner %}
    <h5 style="margin-top:20px;">Session Controls</h5>
    <button id="end-btn" class="copy-btn" style="background:#ff0055;">End Session</button>
    <button id="set-timeout" class="copy-btn">Set Auto Timeout</button>
    <div id="timeout-box" style="display:none;margin-top:10px;">
      <input id="timeout-min" type="number" min="1" placeholder="Minutes" style="padding:6px;border-radius:6px;">
      <button id="apply-timeout" class="copy-btn">Apply</button>
    </div>
    {% endif %}
  </div>
</div>

<p class="footer-text">Â© 2025 ShieldNet | Developed by Team CyberWarriors</p>
<div class="toast-container" id="toast-container"></div>

<script>
const token="{{token}}";const socket=io();let selectedFiles=[];let timeoutInterval;
socket.emit('join_room',{token:token,user:"{{current_user.username}}"});

// Toast
function showToast(msg){const c=document.getElementById('toast-container');
const t=document.createElement('div');t.className='toast';t.textContent=msg;
c.appendChild(t);setTimeout(()=>t.classList.add('fade-out'),2500);
setTimeout(()=>t.remove(),3100);}

// Copy Token
document.getElementById("copy-btn").addEventListener("click",()=>{
navigator.clipboard.writeText(document.getElementById("token-text").textContent.trim());
showToast("Token copied ðŸ“‹");});

// Drag & Drop
const drop=document.getElementById("drop-zone"),input=document.getElementById("file-input"),names=document.getElementById("file-names");
drop.addEventListener("click",()=>input.click());
input.addEventListener("change",e=>addFiles(e.target.files));
drop.addEventListener("dragover",e=>{e.preventDefault();drop.classList.add("dragover");});
drop.addEventListener("dragleave",()=>drop.classList.remove("dragover"));
drop.addEventListener("drop",e=>{e.preventDefault();drop.classList.remove("dragover");addFiles(e.dataTransfer.files);});
function addFiles(f){selectedFiles.push(...Array.from(f));names.innerHTML=selectedFiles.map(x=>"ðŸ“„ "+x.name).join("<br>");}

// Upload
document.getElementById("upload-btn").addEventListener("click",()=>{
if(!selectedFiles.length)return showToast("Select files first âš ï¸");uploadFiles(selectedFiles);});
function uploadFiles(files){
const total=files.length;let uploaded=0;
const p=document.getElementById("upload-progress"),w=document.getElementById("progress-wrap"),t=document.getElementById("progress-text");
w.style.display="block";p.value=0;
files.forEach(file=>{
const fd=new FormData();fd.append("file",file);
const xhr=new XMLHttpRequest();xhr.open("POST",`/online/upload/${token}`,true);
xhr.onload=()=>{if(xhr.status===200){uploaded++;const pct=Math.round((uploaded/total)*100);
p.value=pct;t.textContent=pct+"%";addFileToList(file.name);
if(uploaded===total){showToast("All files uploaded âœ…");w.style.display="none";selectedFiles=[];names.innerHTML="";}}};
xhr.send(fd);});}
function addFileToList(f){const li=document.createElement("li");li.innerHTML=f+' â€” <a href="/online/download/'+token+'/'+encodeURIComponent(f)+'" style="color:#00eaff;">Download</a>';
document.getElementById("file-list").appendChild(li);}

// Participants FIXED âœ…
socket.on('participants_update',data=>{
const ul=document.getElementById('participants');
const existing=Array.from(ul.children).map(li=>li.textContent);
ul.innerHTML='';
data.participants.forEach(p=>{
const li=document.createElement('li');
li.textContent=p;
if(!existing.includes(p)){li.classList.add('new-join');}
ul.appendChild(li);
});
document.getElementById('pcount').textContent=data.participants.length;
});

// Timeout Countdown
document.getElementById('set-timeout')?.addEventListener('click',()=>document.getElementById('timeout-box').style.display='block');
document.getElementById('apply-timeout')?.addEventListener('click',async()=>{
const mins=document.getElementById('timeout-min').value;if(!mins)return showToast("Enter minutes â±ï¸");
const fd=new FormData();fd.append('minutes',mins);
const res=await fetch('/online/set_auto_expire/'+token,{method:'POST',body:fd});
const js=await res.json();if(js.status==='ok'){showToast("Auto timeout set for "+mins+"m â°");
startCountdown(mins*60);}});

function startCountdown(seconds){
clearInterval(timeoutInterval);
const bar=document.getElementById('timeout-progress');
const inner=document.getElementById('timeout-bar');
bar.style.display='block';
let remaining=seconds;
timeoutInterval=setInterval(()=>{
remaining--;const pct=(remaining/seconds)*100;
inner.style.width=pct+"%";
if(remaining<=0){clearInterval(timeoutInterval);
bar.style.display='none';showToast("Session expired â³");
window.location="{{ url_for('online_transfer.select_mode') }}";}
},1000);
}

// End Session
document.getElementById('end-btn')?.addEventListener('click',async()=>{
if(!confirm('End session and delete files?'))return;
const res=await fetch('/online/end/'+token,{method:'POST'});
const js=await res.json();if(js.status==='ended')showToast("Session ended ðŸ›‘");
setTimeout(()=>window.location="{{ url_for('online_transfer.select_mode') }}",1500);});

// Profile Menu
document.querySelector('.profile-icon').addEventListener('click',()=>document.getElementById('profileMenu').classList.toggle('active'));
document.addEventListener('click',e=>{const m=document.getElementById('profileMenu');if(!m.contains(e.target))m.classList.remove('active');});
</script>
</body>
</html>
